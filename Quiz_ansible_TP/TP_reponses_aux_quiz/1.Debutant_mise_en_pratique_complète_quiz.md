<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# \# construire la mise en pratique compl√®te :

- Un seul projet fil rouge: nginx + users + fichiers + r√¥les + vault + ansible-lint.
- Une mise en pratique √©volutive ‚Äú0 ‚Üí 10‚Äù, en plusieurs √©tapes claires.
- Objectif: socle solide de bonnes pratiques.

Je te propose ce ‚Äúlesson plan‚Äù pour la pratique d√©butant 0‚Äì10:

- Step 1: Mise en place du projet propre (arbo + ansible.cfg + inventaire)
- Step 2: Playbook simple Nginx (modules corrects, idempotence)
- Step 3: Ajout gestion users + fichiers (toujours bonnes pratiques)
- Step 4: Passage en r√¥les (web + users) + group_vars
- Step 5: Ajout Vault + ansible-lint + check-mode + tags (niveau 9‚Äì10)

==================================
Step 1 ‚Äì Cr√©ation du projet propre (niveau 0‚Äì2)
==================================

But: partir sur une structure clean d√®s le d√©but (bonne pratique).

1) Cr√©er l‚Äôarborescence:

Dans ton home:

```bash
mkdir -p ~/ansible-nginx-lab/{inventories/dev,playbooks,roles,group_vars}
cd ~/ansible-nginx-lab
```

2) Fichier ansible.cfg (projet, pas global):

`ansible.cfg`:

```ini
[defaults]
inventory = inventories/dev/hosts.ini
host_key_checking = False
retry_files_enabled = False
interpreter_python = auto_silent
roles_path = roles
```

3) Inventaire de base dev:

`inventories/dev/hosts.ini`:

```ini
[webservers]
localhost ansible_connection=local
```

4) Test basique de connexion:
```bash
ansible webservers -m ansible.builtin.ping
```

Question de contr√¥le: tu arrives bien √† obtenir un ‚Äúpong‚Äù sur localhost ?

==================================
Step 2 ‚Äì Premier playbook Nginx simple (niveau 2‚Äì4)
==================================

But: installer nginx proprement, idempotent, avec become.

1) Playbook minimal:

`playbooks/deploy_nginx.yml`:

```yaml
---
- name: D√©ployer Nginx (niveau d√©butant)
  hosts: webservers
  become: true

  tasks:
    - name: Installer le paquet nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: true

    - name: S'assurer que nginx est d√©marr√© et activ√©
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
```

2) Ex√©cution:
```bash
ansible-playbook playbooks/deploy_nginx.yml --ask-become-pass
```

3) Idempotence (niveau 3):

Relance exactement la m√™me commande: la 2e fois, tu dois voir `changed=0` (ou tr√®s proche).

Question: as-tu bien vu que la 2e ex√©cution ne change plus rien ?

==================================
Step 3 ‚Äì Ajout users + fichiers (niveau 3‚Äì6)
==================================

But: couvrir modules user/file/template + permissions explicites.

1) Ajouter un user ‚Äúdeploy‚Äù et un r√©pertoire web sp√©cifique:

On √©tend le m√™me playbook (toujours niveau d√©butant mais plus large):

`playbooks/deploy_nginx.yml` (on ajoute des t√¢ches):

```yaml
---
- name: D√©ployer Nginx + users + fichiers
  hosts: webservers
  become: true

  tasks:
    - name: Cr√©er l'utilisateur deploy
      ansible.builtin.user:
        name: deploy
        shell: /bin/bash
        state: present

    - name: Cr√©er le r√©pertoire web principal
      ansible.builtin.file:
        path: /var/www/myapp
        state: directory
        owner: deploy
        group: deploy
        mode: "0755"

    - name: Installer le paquet nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: true

    - name: S'assurer que nginx est d√©marr√© et activ√©
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true

    - name: D√©ployer une page index statique
      ansible.builtin.copy:
        src: files/index.html
        dest: /var/www/myapp/index.html
        owner: deploy
        group: deploy
        mode: "0644"
```

2) Fichier source:

Cr√©e `files/` (dans le projet, pas dans un r√¥le pour l‚Äôinstant):

```bash
mkdir -p files
```

`files/index.html`:

```html
<!doctype html>
<html>
  <body>
    <h1>Hello from Ansible beginner project</h1>
  </body>
</html>
```

3) Relance le playbook et v√©rifie:

- l‚Äôutilisateur `deploy` existe (`getent passwd deploy`)
- le r√©pertoire `/var/www/myapp` existe avec les bons droits
- le fichier `index.html` est cr√©√©

==================================
Step 4 ‚Äì Passage en r√¥les (web + users) (niveau 5‚Äì8)
==================================

Maintenant on refactore (best practice majeure).

1) Cr√©er deux r√¥les:
```bash
mkdir -p roles/webserver_role/{tasks,handlers,templates}
mkdir -p roles/users_role/tasks
```

2) R√¥le users_role:

`roles/users_role/tasks/main.yml`:

```yaml
---
- name: Cr√©er l'utilisateur deploy
  ansible.builtin.user:
    name: deploy
    shell: /bin/bash
    state: present
```

3) R√¥le webserver_role tasks:

`roles/webserver_role/tasks/main.yml`:

```yaml
---
- name: Installer nginx
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true

- name: Cr√©er le r√©pertoire web principal
  ansible.builtin.file:
    path: /var/www/myapp
    state: directory
    owner: deploy
    group: deploy
    mode: "0755"

- name: D√©ployer la page index via template
  ansible.builtin.template:
    src: index.html.j2
    dest: /var/www/myapp/index.html
    owner: deploy
    group: deploy
    mode: "0644"
  notify: Restart nginx

- name: S'assurer que nginx est d√©marr√© et activ√©
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true
```

4) Handler webserver_role:

`roles/webserver_role/handlers/main.yml`:

```yaml
---
- name: Restart nginx
  ansible.builtin.service:
    name: nginx
    state: restarted
```

5) Template:

`roles/webserver_role/templates/index.html.j2`:

```html
<!doctype html>
<html>
  <body>
    <h1>{{ site_title }}</h1>
    <p>Serveur : {{ inventory_hostname }}</p>
  </body>
</html>
```

6) Variables group_vars (bonne pratique):
```bash
mkdir -p group_vars
```

`group_vars/webservers.yml`:

```yaml
site_title: "Mon site g√©r√© par Ansible (niveau d√©butant++)"
```

7) Nouveau playbook regroup√©:

`playbooks/site.yml`:

```yaml
---
- name: Projet Nginx + users + fichiers via r√¥les
  hosts: webservers
  become: true

  roles:
    - users_role
    - webserver_role
```

8) Test:
```bash
ansible-playbook playbooks/site.yml --ask-become-pass
```

Tu as maintenant:

- r√¥les s√©par√©s pour users et nginx
- variables dans group_vars
- handler pour restart nginx
- template pour le fichier web

==================================
Step 5 ‚Äì Vault + ansible-lint + check-mode + tags (niveau 8‚Äì10)
==================================

But: socle plus ‚Äúpro‚Äù: secrets, v√©rification de qualit√©, ex√©cution fine.

1) Ajouter un secret chiffr√© (ex: mot de passe DB), m√™me si pour l‚Äôinstant on ne l‚Äôutilise que symboliquement.
```bash
ansible-vault create group_vars/all_vault.yml
```

Contenu (une fois ouvert avec vault):

```yaml
db_password: "super-secret-password"
```

Tu relanceras le playbook avec:

```bash
ansible-playbook playbooks/site.yml --ask-become-pass --ask-vault-pass
```

2) Ajouter tags pour cibler:

Dans `roles/users_role/tasks/main.yml`:

```yaml
- name: Cr√©er l'utilisateur deploy
  ansible.builtin.user:
    name: deploy
    shell: /bin/bash
    state: present
  tags: users
```

Dans `roles/webserver_role/tasks/main.yml`, ajoute:

```yaml
- name: Installer nginx
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true
  tags: nginx
```

etc.

Tu pourras alors lancer:

```bash
ansible-playbook playbooks/site.yml --tags nginx --ask-become-pass --ask-vault-pass
```

3) Check-mode (dry run):
```bash
ansible-playbook playbooks/site.yml --check --ask-become-pass --ask-vault-pass
```

4) ansible-lint (best practice qualit√©):

√Ä la racine du projet:

```bash
ansible-lint playbooks/site.yml
```

Corrige ce qu‚Äôil te signale (souvent: permissions, FQCN, etc.).

==================================
O√π tu en es / Socle acquis
==================================

Avec ce projet, tu as pratiqu√©, sur un cas concret:

- Structure propre de projet (ansible.cfg, inventories, playbooks, roles, group_vars)
- Modules de base: apt, service, user, file, copy, template
- Idempotence (en relan√ßant plusieurs fois)
- S√©paration en r√¥les (users_role, webserver_role)
- handlers, templates, group_vars
- Vault basique pour secrets
- Tags, check-mode
- ansible-lint pour les bonnes pratiques

C‚Äôest exactement le socle ‚Äú0 ‚Üí proche interm√©diaire‚Äù que tu voulais.

Question pour valider ton avanc√©e avant de passer √† l‚Äôinterm√©diaire:
Quel fichier contient aujourd‚Äôhui ta variable `site_title`, et dans quel fichier (template ou t√¢che) tu l‚Äôutilises ?
<span style="display:none">[^1][^2][^3][^4][^5][^6][^7][^8][^9]</span>

<div align="center">‚ÅÇ</div>

[^1]: [https://github.com/geerlingguy/ansible-role-nginx](https://github.com/geerlingguy/ansible-role-nginx)

[^2]: [https://spacelift.io/blog/ansible-roles](https://spacelift.io/blog/ansible-roles)

[^3]: [https://blog.nginx.org/blog/official-ansible-galaxy-nginx-roles-out-now](https://blog.nginx.org/blog/official-ansible-galaxy-nginx-roles-out-now)

[^4]: [https://leucos.github.io/ansible-files-layout](https://leucos.github.io/ansible-files-layout)

[^5]: [https://cloudinfrastructureservices.co.uk/ansible-roles-create-use-roles-for-configuration-management/](https://cloudinfrastructureservices.co.uk/ansible-roles-create-use-roles-for-configuration-management/)

[^6]: [https://www.mantra-networking.com/ansible-roles/](https://www.mantra-networking.com/ansible-roles/)

[^7]: [https://serversforhackers.com/c/ansible-roles](https://serversforhackers.com/c/ansible-roles)

[^8]: [https://dev.to/dpuig/creating-an-ansible-playbook-to-install-and-configure-nginx-for-hosting-static-websites-3n6j](https://dev.to/dpuig/creating-an-ansible-playbook-to-install-and-configure-nginx-for-hosting-static-websites-3n6j)

[^9]: [https://docs.nginx.com/nginx-instance-manager/deploy/infrastructure-as-code/configuration/](https://docs.nginx.com/nginx-instance-manager/deploy/infrastructure-as-code/configuration/)

ise en forme, je voudrais qu'elle soit joli et moderne avec des icones en markdow

Voici ta mise en pratique compl√®te mise en forme, moderne et avec des ic√¥nes Markdown pour une meilleure lisibilit√© :

```markdown
# üöÄ Mise en pratique compl√®te Ansible : Nginx + Users + Fichiers + R√¥les + Vault + ansible-lint

## üéØ Objectif
Un projet fil rouge √©volutif pour acqu√©rir un socle solide de bonnes pratiques Ansible, de niveau 0 (d√©butant) √† 10 (proche interm√©diaire).

---

## üóÇÔ∏è Plan de la pratique (Steps 0 ‚Üí 10)

- üõ†Ô∏è **Step 1** : Mise en place du projet propre (arborescence, ansible.cfg, inventaire)
- üì¶ **Step 2** : Playbook simple Nginx (modules d√©di√©s, idempotence)
- üë• **Step 3** : Ajout gestion users + fichiers (avec bonnes pratiques)
- üß© **Step 4** : Passage aux r√¥les (`webserver_role` + `users_role`) + group_vars
- üîê **Step 5** : Int√©gration Vault + ansible-lint + check-mode + tags

---

## Step 1 ‚Äì Cr√©ation du projet propre (niveau 0‚Äì2)

‚ú® *But : partir sur une structure propre d√®s le d√©but.*

```

mkdir -p ~/ansible-nginx-lab/{inventories/dev,playbooks,roles,group_vars}
cd ~/ansible-nginx-lab

```

`ansible.cfg` :

```

[defaults]
inventory = inventories/dev/hosts.ini
host_key_checking = False
retry_files_enabled = False
interpreter_python = auto_silent
roles_path = roles

```

`inventories/dev/hosts.ini` :

```

[webservers]
localhost ansible_connection=local

```

‚úÖ **Test basique** :  
```

ansible webservers -m ansible.builtin.ping

```

---

## Step 2 ‚Äì Premier playbook Nginx simple (niveau 2‚Äì4)

‚ú® *But : Installer Nginx proprement, de fa√ßon idempotente avec become.*

`playbooks/deploy_nginx.yml` :

```


***
- name: D√©ployer Nginx (niveau d√©butant)
hosts: webservers
become: true

tasks:
    - name: Installer le paquet nginx
ansible.builtin.apt:
name: nginx
state: present
update_cache: true
    - name: D√©marrer et activer nginx
ansible.builtin.service:
name: nginx
state: started
enabled: true

```

üõ†Ô∏è **Ex√©cution :**  
```

ansible-playbook playbooks/deploy_nginx.yml --ask-become-pass

```

üîÑ **Idempotence** : Relance la commande, la 2e fois tu dois voir `changed=0`.  

---

## Step 3 ‚Äì Ajout users + fichiers (niveau 3‚Äì6)

‚ú® *But : Couvrir modules `user`, `file`, `template` et g√©rer permissions avec soin.*

`playbooks/deploy_nginx.yml` mis √† jour :

```


***
- name: D√©ployer Nginx + users + fichiers
hosts: webservers
become: true

tasks:
    - name: Cr√©er utilisateur deploy
ansible.builtin.user:
name: deploy
shell: /bin/bash
state: present
    - name: Cr√©er r√©pertoire web principal
ansible.builtin.file:
path: /var/www/myapp
state: directory
owner: deploy
group: deploy
mode: "0755"
    - name: Installer nginx
ansible.builtin.apt:
name: nginx
state: present
update_cache: true
    - name: D√©marrer et activer nginx
ansible.builtin.service:
name: nginx
state: started
enabled: true
    - name: D√©ployer page index statique
ansible.builtin.copy:
src: files/index.html
dest: /var/www/myapp/index.html
owner: deploy
group: deploy
mode: "0644"

```

üìÇ Cr√©e le dossier `files/` et le fichier `files/index.html` :

```

<!doctype html>

<html>
  <body>
    <h1>Hello from Ansible beginner project</h1>
  </body>
</html>
```

‚úÖ **V√©rifications post-d√©ploiement** :
- L‚Äôutilisateur `deploy` existe (`getent passwd deploy`)
- Le r√©pertoire `/var/www/myapp` avec bons droits
- Le fichier `index.html` cr√©√©

---

## Step 4 ‚Äì Passage en r√¥les (web + users) (niveau 5‚Äì8)

‚ú® *But : meilleur d√©coupage (=meilleure maintenabilit√©) avec r√¥les et group_vars*

üöÄ Cr√©er les r√¥les :

```

mkdir -p roles/webserver_role/{tasks,handlers,templates}
mkdir -p roles/users_role/tasks

```

`roles/users_role/tasks/main.yml` :

```


***
- name: Cr√©er l'utilisateur deploy
ansible.builtin.user:
name: deploy
shell: /bin/bash
state: present

```

`roles/webserver_role/tasks/main.yml` :

```


***
- name: Installer nginx
ansible.builtin.apt:
name: nginx
state: present
update_cache: true
- name: Cr√©er r√©pertoire web principal
ansible.builtin.file:
path: /var/www/myapp
state: directory
owner: deploy
group: deploy
mode: "0755"
- name: D√©ployer page index via template
ansible.builtin.template:
src: index.html.j2
dest: /var/www/myapp/index.html
owner: deploy
group: deploy
mode: "0644"
notify: Restart nginx
- name: D√©marrer et activer nginx
ansible.builtin.service:
name: nginx
state: started
enabled: true

```

`roles/webserver_role/handlers/main.yml` :

```


***
- name: Restart nginx
ansible.builtin.service:
name: nginx
state: restarted

```

`roles/webserver_role/templates/index.html.j2` :

```

<!doctype html>

<html>
  <body>
    <h1>{{ site_title }}</h1>
    <p>Serveur : {{ inventory_hostname }}</p>
  </body>
</html>
```

üöÄ Ajoute **group_vars** :

```

mkdir -p group_vars

```

`group_vars/webservers.yml` :

```

site_title: "Mon site g√©r√© par Ansible (niveau d√©butant++)"

```

üöÄ Playbook principal `playbooks/site.yml` :

```


***
- name: Projet Nginx + users + fichiers via r√¥les
hosts: webservers
become: true

roles:
    - users_role
    - webserver_role

```

üõ†Ô∏è **Test :**  
```

ansible-playbook playbooks/site.yml --ask-become-pass

```

---

## Step 5 ‚Äì Vault + ansible-lint + check-mode + tags (niveau 8‚Äì10)

‚ú® *But : socle plus ‚Äúpro‚Äù : secrets, verification qualit√©, ex√©cution fine*

1) Ajouter un secret chiffr√© (m√™me symbolique):

```

ansible-vault create group_vars/all_vault.yml

```

```

db_password: "super-secret-password"

```

‚èØÔ∏è Relancer le playbook avec Vault :

```

ansible-playbook playbooks/site.yml --ask-become-pass --ask-vault-pass

```

2) Ajouter des **tags** dans les r√¥les :

`roles/users_role/tasks/main.yml` :

```

- name: Cr√©er utilisateur deploy
ansible.builtin.user:
name: deploy
shell: /bin/bash
state: present
tags: users

```

`roles/webserver_role/tasks/main.yml` (extrait) :

```

- name: Installer nginx
ansible.builtin.apt:
name: nginx
state: present
update_cache: true
tags: nginx

```

‚èØÔ∏è Exemple : lancer uniquement nginx :

```

ansible-playbook playbooks/site.yml --tags nginx --ask-become-pass --ask-vault-pass

```

3) Check-mode (simulation sans effet) :

```

ansible-playbook playbooks/site.yml --check --ask-become-pass --ask-vault-pass

```

4) **ansible-lint** (analyse la qualit√©) :

```

ansible-lint playbooks/site.yml

```

Corrige ce qu'il signale (permissions, modules, FQCN‚Ä¶).

---

## üèÜ Socle acquis

Tu as pratiqu√© sur un cas concret :

- Structure claire (ansible.cfg, inventories, playbooks, roles, group_vars)
- Modules cl√©s (apt, service, user, file, copy, template)
- Idempotence et bonnes pratiques
- Architecture par r√¥les
- Handlers et templates dynamiques
- Vault pour secrets
- Tags, check-mode pour ex√©cution fine
- ansible-lint pour qualit√© et propret√©

---

## ‚ùì Question de validation

Quel fichier contient ta variable `site_title` ?  
Et dans quel template (ou t√¢che) l‚Äôutilises-tu ?

---

<div align="center">üéØ Pr√™t pour la suite ou un rappel sur un point ?</div>
```


***

Cette mise en forme avec ic√¥nes et sections claires est id√©ale pour une documentation moderne !
Veux-tu que je pr√©pare la m√™me pour les niveaux interm√©diaire et avanc√© ?

