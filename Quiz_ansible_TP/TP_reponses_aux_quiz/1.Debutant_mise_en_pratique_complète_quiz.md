# construire la mise en pratique complète :

- Un seul projet fil rouge: nginx + users + fichiers + rôles + vault + ansible-lint.
- Une mise en pratique évolutive “0 → 10”, en plusieurs étapes claires.
- Objectif: socle solide de bonnes pratiques.

Je te propose ce “lesson plan” pour la pratique débutant 0–10:

- Step 1: Mise en place du projet propre (arbo + ansible.cfg + inventaire)
- Step 2: Playbook simple Nginx (modules corrects, idempotence)
- Step 3: Ajout gestion users + fichiers (toujours bonnes pratiques)
- Step 4: Passage en rôles (web + users) + group_vars
- Step 5: Ajout Vault + ansible-lint + check-mode + tags (niveau 9–10)

==================================
Step 1 – Création du projet propre (niveau 0–2)
==================================

But: partir sur une structure clean dès le début (bonne pratique).

1) Créer l’arborescence:

Dans ton home:

```bash
mkdir -p ~/ansible-nginx-lab/{inventories/dev,playbooks,roles,group_vars}
cd ~/ansible-nginx-lab
```

2) Fichier ansible.cfg (projet, pas global):

`ansible.cfg`:

```ini
[defaults]
inventory = inventories/dev/hosts.ini
host_key_checking = False
retry_files_enabled = False
interpreter_python = auto_silent
roles_path = roles
```

3) Inventaire de base dev:

`inventories/dev/hosts.ini`:

```ini
[webservers]
localhost ansible_connection=local
```

4) Test basique de connexion:
```bash
ansible webservers -m ansible.builtin.ping
```

Question de contrôle: tu arrives bien à obtenir un “pong” sur localhost ?

==================================
Step 2 – Premier playbook Nginx simple (niveau 2–4)
==================================

But: installer nginx proprement, idempotent, avec become.

1) Playbook minimal:

`playbooks/deploy_nginx.yml`:

```yaml
---
- name: Déployer Nginx (niveau débutant)
  hosts: webservers
  become: true

  tasks:
    - name: Installer le paquet nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: true

    - name: S'assurer que nginx est démarré et activé
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
```

2) Exécution:
```bash
ansible-playbook playbooks/deploy_nginx.yml --ask-become-pass
```

3) Idempotence (niveau 3):

Relance exactement la même commande: la 2e fois, tu dois voir `changed=0` (ou très proche).

Question: as-tu bien vu que la 2e exécution ne change plus rien ?

==================================
Step 3 – Ajout users + fichiers (niveau 3–6)
==================================

But: couvrir modules user/file/template + permissions explicites.

1) Ajouter un user “deploy” et un répertoire web spécifique:

On étend le même playbook (toujours niveau débutant mais plus large):

`playbooks/deploy_nginx.yml` (on ajoute des tâches):

```yaml
---
- name: Déployer Nginx + users + fichiers
  hosts: webservers
  become: true

  tasks:
    - name: Créer l'utilisateur deploy
      ansible.builtin.user:
        name: deploy
        shell: /bin/bash
        state: present

    - name: Créer le répertoire web principal
      ansible.builtin.file:
        path: /var/www/myapp
        state: directory
        owner: deploy
        group: deploy
        mode: "0755"

    - name: Installer le paquet nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: true

    - name: S'assurer que nginx est démarré et activé
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true

    - name: Déployer une page index statique
      ansible.builtin.copy:
        src: files/index.html
        dest: /var/www/myapp/index.html
        owner: deploy
        group: deploy
        mode: "0644"
```

2) Fichier source:

Crée `files/` (dans le projet, pas dans un rôle pour l’instant):

```bash
mkdir -p files
```

`files/index.html`:

```html
<!doctype html>
<html>
  <body>
    <h1>Hello from Ansible beginner project</h1>
  </body>
</html>
```

3) Relance le playbook et vérifie:

- l’utilisateur `deploy` existe (`getent passwd deploy`)
- le répertoire `/var/www/myapp` existe avec les bons droits
- le fichier `index.html` est créé

==================================
Step 4 – Passage en rôles (web + users) (niveau 5–8)
==================================

Maintenant on refactore (best practice majeure).

1) Créer deux rôles:
```bash
mkdir -p roles/webserver_role/{tasks,handlers,templates}
mkdir -p roles/users_role/tasks
```

2) Rôle users_role:

`roles/users_role/tasks/main.yml`:

```yaml
---
- name: Créer l'utilisateur deploy
  ansible.builtin.user:
    name: deploy
    shell: /bin/bash
    state: present
```

3) Rôle webserver_role tasks:

`roles/webserver_role/tasks/main.yml`:

```yaml
---
- name: Installer nginx
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true

- name: Créer le répertoire web principal
  ansible.builtin.file:
    path: /var/www/myapp
    state: directory
    owner: deploy
    group: deploy
    mode: "0755"

- name: Déployer la page index via template
  ansible.builtin.template:
    src: index.html.j2
    dest: /var/www/myapp/index.html
    owner: deploy
    group: deploy
    mode: "0644"
  notify: Restart nginx

- name: S'assurer que nginx est démarré et activé
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true
```

4) Handler webserver_role:

`roles/webserver_role/handlers/main.yml`:

```yaml
---
- name: Restart nginx
  ansible.builtin.service:
    name: nginx
    state: restarted
```

5) Template:

`roles/webserver_role/templates/index.html.j2`:

```html
<!doctype html>
<html>
  <body>
    <h1>{{ site_title }}</h1>
    <p>Serveur : {{ inventory_hostname }}</p>
  </body>
</html>
```

6) Variables group_vars (bonne pratique):
```bash
mkdir -p group_vars
```

`group_vars/webservers.yml`:

```yaml
site_title: "Mon site géré par Ansible (niveau débutant++)"
```

7) Nouveau playbook regroupé:

`playbooks/site.yml`:

```yaml
---
- name: Projet Nginx + users + fichiers via rôles
  hosts: webservers
  become: true

  roles:
    - users_role
    - webserver_role
```

8) Test:
```bash
ansible-playbook playbooks/site.yml --ask-become-pass
```

Tu as maintenant:

- rôles séparés pour users et nginx
- variables dans group_vars
- handler pour restart nginx
- template pour le fichier web

==================================
Step 5 – Vault + ansible-lint + check-mode + tags (niveau 8–10)
==================================

But: socle plus “pro”: secrets, vérification de qualité, exécution fine.

1) Ajouter un secret chiffré (ex: mot de passe DB), même si pour l’instant on ne l’utilise que symboliquement.
```bash
ansible-vault create group_vars/all_vault.yml
```

Contenu (une fois ouvert avec vault):

```yaml
db_password: "super-secret-password"
```

Tu relanceras le playbook avec:

```bash
ansible-playbook playbooks/site.yml --ask-become-pass --ask-vault-pass
```

2) Ajouter tags pour cibler:

Dans `roles/users_role/tasks/main.yml`:

```yaml
- name: Créer l'utilisateur deploy
  ansible.builtin.user:
    name: deploy
    shell: /bin/bash
    state: present
  tags: users
```

Dans `roles/webserver_role/tasks/main.yml`, ajoute:

```yaml
- name: Installer nginx
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true
  tags: nginx
```

etc.

Tu pourras alors lancer:

```bash
ansible-playbook playbooks/site.yml --tags nginx --ask-become-pass --ask-vault-pass
```

3) Check-mode (dry run):
```bash
ansible-playbook playbooks/site.yml --check --ask-become-pass --ask-vault-pass
```

4) ansible-lint (best practice qualité):

À la racine du projet:

```bash
ansible-lint playbooks/site.yml
```

Corrige ce qu’il te signale (souvent: permissions, FQCN, etc.).

==================================
Où tu en es / Socle acquis
==================================

Avec ce projet, tu as pratiqué, sur un cas concret:

- Structure propre de projet (ansible.cfg, inventories, playbooks, roles, group_vars)
- Modules de base: apt, service, user, file, copy, template
- Idempotence (en relançant plusieurs fois)
- Séparation en rôles (users_role, webserver_role)
- handlers, templates, group_vars
- Vault basique pour secrets
- Tags, check-mode
- ansible-lint pour les bonnes pratiques

C’est exactement le socle “0 → proche intermédiaire” que tu voulais.

Question pour valider ton avancée avant de passer à l’intermédiaire:
Quel fichier contient aujourd’hui ta variable `site_title`, et dans quel fichier (template ou tâche) tu l’utilises ?
<span style="display:none">[^1][^2][^3][^4][^5][^6][^7][^8][^9]</span>

<div align="center">⁂</div>

[^1]: https://github.com/geerlingguy/ansible-role-nginx

[^2]: https://spacelift.io/blog/ansible-roles

[^3]: https://blog.nginx.org/blog/official-ansible-galaxy-nginx-roles-out-now

[^4]: https://leucos.github.io/ansible-files-layout

[^5]: https://cloudinfrastructureservices.co.uk/ansible-roles-create-use-roles-for-configuration-management/

[^6]: https://www.mantra-networking.com/ansible-roles/

[^7]: https://serversforhackers.com/c/ansible-roles

[^8]: https://dev.to/dpuig/creating-an-ansible-playbook-to-install-and-configure-nginx-for-hosting-static-websites-3n6j

[^9]: https://docs.nginx.com/nginx-instance-manager/deploy/infrastructure-as-code/configuration/

