
# Guide de Référence : ansible-galaxy - Best Practices

## 1. Objectif et Périmètre

Ce guide référence technique détaille l'utilisation d'`ansible-galaxy` pour consommer et créer du contenu Ansible (rôles et collections) de manière professionnelle. Il se concentre **uniquement sur les best practices** : reproductibilité, sécurité, maintenabilité et scalabilité.

- **Niveau** : Débutant à avancé.
- **Prérequis** : Connaissances de base Ansible (playbooks, rôles).
- **Non couvert** : Modules personnalisés ou plugins avancés ; focus sur Galaxy.

Objectif : Créer des projets Ansible autonomes, versionnés et collaboratifs, évitant les pièges courants comme les installations "à la main" ou les versions non fixées.

## 2. Concepts Clés : Rôles, Collections, ansible-galaxy

`ansible-galaxy` est à la fois :

- Un **catalogue en ligne** (galaxy.ansible.com) de contenus réutilisables.
- Une **CLI** pour installer, créer et gérer ces contenus.


### Rôles vs Collections

- **Rôle** : Brique fine, orientée fonctionnalité (ex. : installer/configurer Nginx). Contient tasks, handlers, vars, templates. Idéal pour des besoins OS/applicatifs spécifiques.
- **Collection** : Paquet plus large (rôles + modules + plugins + docs). Souvent vendor-spécifique (ex. : `cisco.ios`) ou général (ex. : `community.general`). Utilisé pour du contenu modulaire et extensible.

Best practice : Utilise des rôles pour la logique applicative ; des collections pour des outils transversaux (système, cloud). Évite les rôles "lourds" ; préfère les collections officielles pour la fiabilité.

## 3. Organisation d'un Projet Ansible Moderne

Un projet bien structuré est isolé, versionné (Git) et reproductible. Évite les dossiers globaux comme `/etc/ansible/roles`.

### Structure Recommandée

```
my-ansible-project/
├── ansible.cfg                  # Config locale (roles_path, collections_paths)
├── inventory/
│   └── hosts.ini                # Ou dynamique (AWS, etc.)
├── group_vars/                  # Vars par groupe (all.yml, webservers.yml)
├── host_vars/                   # Vars par hôte
├── playbooks/
│   └── site.yml                 # Playbook principal (importe rôles/collections)
├── roles/
│   └── requirements.yml         # Dépendances rôles
├── collections/
│   └── requirements.yml         # Dépendances collections
├── .gitignore                   # Ignore .retry, .vault
└── README.md                    # Usage, prérequis
```


### Exemple ansible.cfg (Best Practice)

```ini
[defaults]
inventory = ./inventory
roles_path = ./roles
collections_paths = ./collections
host_key_checking = False  # À activer en prod
retry_files_enabled = False
gathering = smart
fact_caching = jsonfile
fact_caching_connection = ./cache

[inventory]
enable_plugins = host_list, script, auto, yaml, ini, toml
```

Best practice :

- Place tout au niveau du projet (pas de refs globales).
- Utilise `group_vars`/`host_vars` pour séparer données de logique.
- Commit tout dans Git ; utilise branches (main, dev) et tags pour releases.


## 4. Consommer des Rôles avec ansible-galaxy

### 4.1 Commandes de Base

- Recherche : `ansible-galaxy role search nginx` (filtre par tags, auteur).
- Installation manuelle (pour tests seulement) : `ansible-galaxy role install geerlingguy.nginx -p ./roles`.
- **Évite** : Installations "latest" sans version ; pollue les paths globaux.


### 4.2 Fichier roles/requirements.yml

Déclare les dépendances de manière déclarative et versionnée.

Exemple détaillé :

```yaml
---
- name: geerlingguy.nginx
  version: "3.1.4"              # Fixe pour reproductibilité
  src: geerlingguy.nginx        # Namespace.auteur.nom
- name: geerlingguy.mysql
  version: ">=5.1.0,<6.0.0"     # Range sémantique (évite breaking changes)
- name: mycompany.custom-role   # Rôle Git local/privé
  src: https://github.com/mycompany/custom-role.git
  version: "v1.2.3"
  scm: git
```


### 4.3 Bonnes Pratiques d'Installation

- Installation : `ansible-galaxy install -r roles/requirements.yml -p ./roles`.
- Pourquoi `-p ./roles` ? Isolation par projet ; évite conflits de versions entre projets.
- Vérification : `ansible-galaxy role list` (liste installés).
- Mise à jour : `ansible-galaxy install -r roles/requirements.yml --force` (seulement après tests).
- Best practice :
    - Toujours fixer versions (pas "latest") pour rollback et CI/CD.
    - Revue de source : Vérifie README, issues sur Galaxy ; préfère auteurs fiables (geerlingguy, Red Hat).
    - Sécurité : N'installe pas de rôles anonymes ; utilise `ansible-lint` post-install pour valider.

Dans un playbook : `roles: - geerlingguy.nginx` (Ansible charge auto depuis `./roles`).

## 5. Consommer des Collections avec ansible-galaxy

### 5.1 Commandes de Base

- Recherche : `ansible-galaxy collection search posix`.
- Installation : `ansible-galaxy collection install ansible.posix -p ./collections`.


### 5.2 Fichier collections/requirements.yml

Similaire aux rôles, mais pour des paquets plus larges.

Exemple détaillé :

```yaml
---
collections:
  - name: ansible.posix
    version: "1.5.4"             # Modules système (users, firewalld)
  - name: community.general
    version: "9.0.0"             # Outils généraux (apt, service)
    source: https://galaxy.ansible.com  # Mirroir par défaut
  - name: amazon.aws
    version: ">=6.0.0"
    source: https://galaxy.ansible.com
```


### 5.3 Bonnes Pratiques d'Utilisation

- Installation : `ansible-galaxy collection install -r collections/requirements.yml -p ./collections`.
- Dans un playbook : Utilise modules comme `ansible.posix.synchronize` (Ansible les trouve auto).
- Best practice :
    - Privilégie collections officielles/community pour modules (ex. : `community.general` pour apt/yum).
    - Évite collections trop lourdes : Installe seulement ce dont tu as besoin ; teste avec `ansible-doc`.
    - Versioning : Utilise ranges sémantiques pour mises à jour mineures ; teste breaking changes.
    - Intégration : Ajoute à `ansible.cfg` : `collections_paths = ./collections`.


## 6. Créer un Rôle Propre avec ansible-galaxy init

### 6.1 Structure Générée et Rôle de Chaque Dossier

Commande : `ansible-galaxy init mon-role -p ./roles`.

Structure générée :

```
mon-role/
├── defaults/
│   └── main.yml                # Vars par défaut (surchargeables)
├── files/                      # Fichiers statiques à copier
├── handlers/
│   └── main.yml                # Actions déclenchées (ex. : restart service)
├── meta/
│   └── main.yml                # Dépendances, galaxy info (auteur, version)
├── tasks/
│   └── main.yml                # Logique principale (tâches)
├── templates/                  # Templates Jinja2 (configs dynamiques)
├── tests/                      # Tests (optionnel, pour Molecule)
├── vars/
│   └── main.yml                # Vars internes fortes (non surchargeables)
└── README.md                   # Doc : usage, vars, exemples
```

Best practice : Respecte cette structure pour la portabilité ; utilise `ansible-galaxy role list` pour vérifier.

### 6.2 Gestion des Variables (defaults vs vars)

- `defaults/main.yml` : Vars configurables (priorité faible, surchargeables via inventaire/extra-vars).
Exemple :

```yaml
---
nginx_port: 80
nginx_user: www-data
nginx_packages: ['nginx']
```

- `vars/main.yml` : Vars internes fixes (priorité haute, rarement utilisées).
Exemple :

```yaml
---
nginx_internal_path: /etc/nginx/internal
```


Best practice : 90% des vars en `defaults/` pour flexibilité ; documente-les dans README.

### 6.3 Handlers, Templates, Files

- Handlers : Définis dans `handlers/main.yml` ; notifiés par tasks (ex. : `notify: restart nginx`).
Exemple :

```yaml
---
- name: restart nginx
  systemd:
    name: nginx
    state: restarted
```

- Templates : `.j2` dans `templates/` (ex. : `nginx.conf.j2` avec `{{ nginx_port }}`).
- Files : Copie statique (ex. : logos, scripts fixes).

Best practice : Rends tout idempotent (état final, pas "always run") ; utilise tags pour granularité.

### 6.4 Métadonnées et README

- `meta/main.yml` :

```yaml
---
galaxy_info:
  author: tonnom
  description: Rôle Nginx sécurisé
  min_ansible_version: 2.9
  platforms: [debian, ubuntu]
dependencies: [geerlingguy.firewall]
```

- README.md : Usage, vars requises, exemples playbook, troubleshooting.

Best practice : Remplis `galaxy_info` pour publication ; ajoute license (MIT/GPL).

## 7. Bonnes Pratiques Avancées

### 7.1 Gestion des Versions et Reproductibilité

- Versioning sémantique (SemVer) : `v1.0.0` dans `meta/main.yml` et Git tags.
- requirements.yml : Utilise `>=1.0.0,<2.0.0` pour maj mineures ; teste upgrades.
- CI/CD : Intègre `ansible-galaxy install -r requirements.yml` dans pipelines (GitHub Actions, GitLab CI).
- Best practice : Lockfile (génère `roles/requirements.lock.yml` avec versions exactes pour prod).


### 7.2 Intégration CI/CD (Tests, Molecule)

- Tests : Utilise Molecule pour tester rôles isolés (`molecule init role --role-name mon-role`).
- Linting : `ansible-lint roles/mon-role` ; ajoute à CI.
- Publication : `ansible-galaxy role import tonnom mon-role` (après tests).
- Best practice : Tests idempotence, convergence ; coverage >80% ; rôle testable en 5 min.


### 7.3 Sécurité et Confiance (Sources, Revue)

- Sources : Privilégie Galaxy officiel ; vérifie signatures (à venir) ; évite GitHub non-vérifiés.
- Revue : Lis code source ; cherche issues/stars sur Galaxy ; utilise `ansible-galaxy collection verify`.
- Secrets : Jamais en dur ; utilise Vault ou external (HashiCorp Vault).
- Best practice : Audit régulier (Lynis pour rôles OS) ; MFA pour Galaxy ; pas de root en tasks.


## 8. Résumé et Checklist Rapide

Ce guide t'équipe pour un usage pro d'`ansible-galaxy` : de la conso propre à la création avancée, en visant reproductibilité et sécurité.

**Checklist pour un Projet Neuf** :

- [ ] Crée structure : `roles/requirements.yml`, `collections/requirements.yml`, `ansible.cfg`.
- [ ] Fixe versions dans requirements ; installe avec `-p ./local`.
- [ ] Crée rôles via `ansible-galaxy init` ; vars en `defaults/`, logique en `tasks/`.
- [ ] Teste avec Molecule/ansible-lint ; versionne en Git.
- [ ] Documente README ; publie si partagé.

Pour approfondir : Docs Ansible officielles. Applique pas à pas pour scaler tes automatisations !

***

Ça te va comme référence FR ? Dis-moi si tu veux ajuster (ex. : plus d'exemples), puis on passe à l'EN. Quelle section as-tu le plus hâte de tester en pratique ?
<span style="display:none">[^1][^2][^3][^4][^5][^6][^7][^8][^9]</span>

<div align="center">⁂</div>

[^1]: https://galaxy.ansible.com/ui/repo/published/alexbarton/boilerplate/docs/ansible-best-practices/

[^2]: https://blog.stephane-robert.info/docs/infra-as-code/gestion-de-configuration/ansible/ansible-best-practices-tips/

[^3]: https://docs.ansible.com/projects/ansible/latest/dev_guide/developing_modules_best_practices.html

[^4]: https://spacelift.io/blog/ansible-best-practices

[^5]: https://blog.cloudmylab.com/best-practices-ansible-playbooks

[^6]: https://www.reddit.com/r/ansible/comments/1fo7vrx/what_are_the_best_practices_for_organizing/

[^7]: https://docs.ansible.com/projects/ansible/latest/galaxy/user_guide.html

[^8]: https://www.redhat.com/fr/blog/ansible-galaxy-intro

[^9]: https://docs.ansible.com/projects/ansible/2.9/user_guide/playbooks_best_practices.html

